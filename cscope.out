cscope 15 $HOME/Project/BranOS               0000009338
	@gdt.c

1 
	~<sy°em.h
>

6 
	sgdt_íåy


8 
	mlimô_low
;

9 
	mba£_low
;

10 
	mba£_middÀ
;

11 
	mac˚ss
;

12 
	mgønuœrôy
;

13 
	mba£_high
;

14 } 
__©åibuã__
((
∑cked
));

18 
	sgdt_±r


20 
	mlimô
;

21 
	mba£
;

22 } 
__©åibuã__
((
∑cked
));

25 
gdt_íåy
 
	ggdt
[3];

26 
gdt_±r
 
	ggp
;

30 
gdt_Êush
();

33 
	$gdt_£t_g©e
(
num
, 
ba£
, 
limô
, 
ac˚ss
, 
gøn
)

36 
gdt
[
num
].
ba£_low
 = (
ba£
 & 0xFFFF);

37 
gdt
[
num
].
ba£_middÀ
 = (
ba£
 >> 16) & 0xFF;

38 
gdt
[
num
].
ba£_high
 = (
ba£
 >> 24) & 0xFF;

41 
gdt
[
num
].
limô_low
 = (
limô
 & 0xFFFF);

42 
gdt
[
num
].
gønuœrôy
 = ((
limô
 >> 16) & 0x0F);

45 
gdt
[
num
].
gønuœrôy
 |(
gøn
 & 0xF0);

46 
gdt
[
num
].
ac˚ss
 =áccess;

47 
	}
}

54 
	$gdt_ö°Æl
()

57 
gp
.
limô
 = ((
gdt_íåy
) * 3) - 1;

58 
gp
.
ba£
 = &
gdt
;

61 
	`gdt_£t_g©e
(0, 0, 0, 0, 0);

68 
	`gdt_£t_g©e
(1, 0, 0xFFFFFFFF, 0x9A, 0xCF);

73 
	`gdt_£t_g©e
(2, 0, 0xFFFFFFFF, 0x92, 0xCF);

76 
	`gdt_Êush
();

77 
	}
}

	@idt.c

1 
	~<sy°em.h
>

4 
	sidt_íåy


6 
	mba£_lo
;

7 
	m£l
;

8 
	mÆways0
;

9 
	mÊags
;

10 
	mba£_hi
;

11 } 
__©åibuã__
((
∑cked
));

13 
	sidt_±r


15 
	mlimô
;

16 
	mba£
;

17 } 
__©åibuã__
((
∑cked
));

25 
idt_íåy
 
	gidt
[256];

26 
idt_±r
 
	gidç
;

29 
idt_lﬂd
();

33 
	$idt_£t_g©e
(
num
, 
ba£
, 
£l
, 
Êags
)

36 
idt
[
num
].
ba£_lo
 = (
ba£
 & 0xFFFF);

37 
idt
[
num
].
ba£_hi
 = (
ba£
 >> 16) & 0xFFFF;

41 
idt
[
num
].
£l
 = sel;

42 
idt
[
num
].
Æways0
 = 0;

43 
idt
[
num
].
Êags
 = flags;

44 
	}
}

47 
	$idt_ö°Æl
()

50 
idç
.
limô
 = ( (
idt_íåy
) * 256) - 1;

51 
idç
.
ba£
 = &
idt
;

54 
	`mem£t
(&
idt
, 0, (
idt_íåy
) * 256);

59 
	`idt_lﬂd
();

60 
	}
}

	@irq.c

1 
	~<sy°em.h
>

5 
úq0
();

6 
úq1
();

7 
úq2
();

8 
úq3
();

9 
úq4
();

10 
úq5
();

11 
úq6
();

12 
úq7
();

13 
úq8
();

14 
úq9
();

15 
úq10
();

16 
úq11
();

17 
úq12
();

18 
úq13
();

19 
úq14
();

20 
úq15
();

24 *
	gúq_routöes
[16] =

31 
úq_ö°Æl_h™dÀr
(
úq
, (*
h™dÀr
)(
ªgs
 *
r
))

33 
úq_routöes
[
úq
] = 
h™dÀr
;

34 
	}
}

37 
	$úq_unö°Æl_h™dÀr
(
úq
)

39 
úq_routöes
[
úq
] = 0;

40 
	}
}

50 
	$úq_ªm≠
()

52 
	`ouç‹tb
(0x20, 0x11);

53 
	`ouç‹tb
(0xA0, 0x11);

54 
	`ouç‹tb
(0x21, 0x20);

55 
	`ouç‹tb
(0xA1, 0x28);

56 
	`ouç‹tb
(0x21, 0x04);

57 
	`ouç‹tb
(0xA1, 0x02);

58 
	`ouç‹tb
(0x21, 0x01);

59 
	`ouç‹tb
(0xA1, 0x01);

60 
	`ouç‹tb
(0x21, 0x0);

61 
	`ouç‹tb
(0xA1, 0x0);

62 
	}
}

67 
	$úq_ö°Æl
()

69 
	`úq_ªm≠
();

71 
	`idt_£t_g©e
(32, ()
úq0
, 0x08, 0x8E);

72 
	`idt_£t_g©e
(33, ()
úq1
, 0x08, 0x8E);

73 
	`idt_£t_g©e
(34, ()
úq2
, 0x08, 0x8E);

74 
	`idt_£t_g©e
(35, ()
úq3
, 0x08, 0x8E);

75 
	`idt_£t_g©e
(36, ()
úq4
, 0x08, 0x8E);

76 
	`idt_£t_g©e
(37, ()
úq5
, 0x08, 0x8E);

77 
	`idt_£t_g©e
(38, ()
úq6
, 0x08, 0x8E);

78 
	`idt_£t_g©e
(39, ()
úq7
, 0x08, 0x8E);

79 
	`idt_£t_g©e
(40, ()
úq8
, 0x08, 0x8E);

80 
	`idt_£t_g©e
(41, ()
úq9
, 0x08, 0x8E);

81 
	`idt_£t_g©e
(42, ()
úq10
, 0x08, 0x8E);

82 
	`idt_£t_g©e
(43, ()
úq11
, 0x08, 0x8E);

83 
	`idt_£t_g©e
(44, ()
úq12
, 0x08, 0x8E);

84 
	`idt_£t_g©e
(45, ()
úq13
, 0x08, 0x8E);

85 
	`idt_£t_g©e
(46, ()
úq14
, 0x08, 0x8E);

86 
	`idt_£t_g©e
(47, ()
úq15
, 0x08, 0x8E);

87 
	}
}

98 
	$úq_h™dÀr
(
ªgs
 *
r
)

101 (*
h™dÀr
)(
ªgs
 *
r
);

105 
h™dÀr
 = 
úq_routöes
[
r
->
öt_no
 - 32];

106 i‡(
h™dÀr
)

108 
	`h™dÀr
(
r
);

114 i‡(
r
->
öt_no
 >= 40)

116 
	`ouç‹tb
(0xA0, 0x20);

121 
	`ouç‹tb
(0x20, 0x20);

122 
	}
}

	@isrs.c

6 
	~<sy°em.h
>

11 
i§0
();

12 
i§1
();

13 
i§2
();

14 
i§3
();

15 
i§4
();

16 
i§5
();

17 
i§6
();

18 
i§7
();

19 
i§8
();

20 
i§9
();

21 
i§10
();

22 
i§11
();

23 
i§12
();

24 
i§13
();

25 
i§14
();

26 
i§15
();

27 
i§16
();

28 
i§17
();

29 
i§18
();

30 
i§19
();

31 
i§20
();

32 
i§21
();

33 
i§22
();

34 
i§23
();

35 
i§24
();

36 
i§25
();

37 
i§26
();

38 
i§27
();

39 
i§28
();

40 
i§29
();

41 
i§30
();

42 
i§31
();

53 
	$i§s_ö°Æl
()

55 
	`idt_£t_g©e
(0, ()
i§0
, 0x08, 0x8E);

56 
	`idt_£t_g©e
(1, ()
i§1
, 0x08, 0x8E);

57 
	`idt_£t_g©e
(2, ()
i§2
, 0x08, 0x8E);

58 
	`idt_£t_g©e
(3, ()
i§3
, 0x08, 0x8E);

59 
	`idt_£t_g©e
(4, ()
i§4
, 0x08, 0x8E);

60 
	`idt_£t_g©e
(5, ()
i§5
, 0x08, 0x8E);

61 
	`idt_£t_g©e
(6, ()
i§6
, 0x08, 0x8E);

62 
	`idt_£t_g©e
(7, ()
i§7
, 0x08, 0x8E);

64 
	`idt_£t_g©e
(8, ()
i§8
, 0x08, 0x8E);

65 
	`idt_£t_g©e
(9, ()
i§9
, 0x08, 0x8E);

66 
	`idt_£t_g©e
(10, ()
i§10
, 0x08, 0x8E);

67 
	`idt_£t_g©e
(11, ()
i§11
, 0x08, 0x8E);

68 
	`idt_£t_g©e
(12, ()
i§12
, 0x08, 0x8E);

69 
	`idt_£t_g©e
(13, ()
i§13
, 0x08, 0x8E);

70 
	`idt_£t_g©e
(14, ()
i§14
, 0x08, 0x8E);

71 
	`idt_£t_g©e
(15, ()
i§15
, 0x08, 0x8E);

73 
	`idt_£t_g©e
(16, ()
i§16
, 0x08, 0x8E);

74 
	`idt_£t_g©e
(17, ()
i§17
, 0x08, 0x8E);

75 
	`idt_£t_g©e
(18, ()
i§18
, 0x08, 0x8E);

76 
	`idt_£t_g©e
(19, ()
i§19
, 0x08, 0x8E);

77 
	`idt_£t_g©e
(20, ()
i§20
, 0x08, 0x8E);

78 
	`idt_£t_g©e
(21, ()
i§21
, 0x08, 0x8E);

79 
	`idt_£t_g©e
(22, ()
i§22
, 0x08, 0x8E);

80 
	`idt_£t_g©e
(23, ()
i§23
, 0x08, 0x8E);

82 
	`idt_£t_g©e
(24, ()
i§24
, 0x08, 0x8E);

83 
	`idt_£t_g©e
(25, ()
i§25
, 0x08, 0x8E);

84 
	`idt_£t_g©e
(26, ()
i§26
, 0x08, 0x8E);

85 
	`idt_£t_g©e
(27, ()
i§27
, 0x08, 0x8E);

86 
	`idt_£t_g©e
(28, ()
i§28
, 0x08, 0x8E);

87 
	`idt_£t_g©e
(29, ()
i§29
, 0x08, 0x8E);

88 
	`idt_£t_g©e
(30, ()
i§30
, 0x08, 0x8E);

89 
	`idt_£t_g©e
(31, ()
i§31
, 0x08, 0x8E);

90 
	}
}

96 *
	gex˚±i⁄_mesßges
[] =

141 
	$Áu…_h™dÀr
(
ªgs
 *
r
)

143 i‡(
r
->
öt_no
 < 32)

145 
	`puts
(
ex˚±i⁄_mesßges
[
r
->
öt_no
]);

146 
	`puts
(" Exception. System Halted!\n");

149 
	}
}

	@kb.c

6 
	gkbdus
[128] =

47 
	$keybﬂrd_h™dÀr
(
ªgs
 *
r
)

49 
sˇncode
;

52 
sˇncode
 = 
	`öp‹tb
(0x60);

56 i‡(
sˇncode
 & 0x80)

75 
	`putch
(
kbdus
[
sˇncode
]);

77 
	}
}

79 
	$keybﬂrd_ö°Æl
()

81 
	`úq_i°Æl_h™dÀr
(1,
keybﬂrd_h™dÀr
);

82 
	}
}

	@main.c

6 
	~<sy°em.h
>

8 *
	$mem˝y
(*
de°
, c⁄° *
§c
, 
size_t
 
cou¡
)

10 c⁄° *
•
 = (c⁄° *)
§c
;

11 *
dp
 = (*)
de°
;

12 ; 
cou¡
 !0; cou¡--Ë*
dp
++ = *
•
++;

13  
de°
;

14 
	}
}

16 *
	$mem£t
(*
de°
, 
vÆ
, 
size_t
 
cou¡
)

18 *
ãmp
 = (*)
de°
;

19  ; 
cou¡
 !0; cou¡--Ë*
ãmp
++ = 
vÆ
;

20  
de°
;

21 
	}
}

23 *
	$mem£tw
(*
de°
, 
vÆ
, 
size_t
 
cou¡
)

25 *
ãmp
 = (*)
de°
;

26  ; 
cou¡
 !0; cou¡--Ë*
ãmp
++ = 
vÆ
;

27  
de°
;

28 
	}
}

30 
size_t
 
	$°æí
(c⁄° *
°r
)

32 
size_t
 
ªtvÆ
;

33 
ªtvÆ
 = 0; *
°r
 != '\0'; str++)Ñetval++;

34  
ªtvÆ
;

35 
	}
}

37 
	$öp‹tb
 (
_p‹t
)

39 
rv
;

40 
__asm__
 
	`__vﬁ©ûe__
 ("öb %1, %0" : "˜" (
rv
Ë: "dN" (
_p‹t
));

41  
rv
;

42 
	}
}

44 
	$ouç‹tb
 (
_p‹t
, 
_d©a
)

46 
__asm__
 
	`__vﬁ©ûe__
 ("outb %1, %0" : : "dN" (
_p‹t
), "a" (
_d©a
));

47 
	}
}

49 
	$maö
()

51 
i
;

53 
	`gdt_ö°Æl
();

54 
	`idt_ö°Æl
();

55 
	`i§s_ö°Æl
();

56 
	`úq_ö°Æl
();

57 
	`öô_video
();

58 
	`timî_ö°Æl
();

59 
	`keybﬂrd_ö°Æl
();

61 
__asm__
 
	`__vﬁ©ûe__
 ("sti");

63 
	`puts
("Hello World!\n");

70 
	}
}

	@scrn.c

1 
	~< sy°em.h 
>

5 *
	gãxtmem±r
;

6 
	g©åib
 = 0x0F;

7 
	gc§_x
 = 0, 
	gc§_y
 = 0;

10 
	$s¸ﬁl
()

12 
bœnk
, 
ãmp
;

16 
bœnk
 = 0x20 | (
©åib
 << 8);

19 if(
c§_y
 >= 25)

23 
ãmp
 = 
c§_y
 - 25 + 1;

24 
	`mem˝y
 (
ãxtmem±r
,Åextmem±∏+ 
ãmp
 * 80, (25 -Åemp) * 80 * 2);

28 
	`mem£tw
 (
ãxtmem±r
 + (25 - 
ãmp
Ë* 80, 
bœnk
, 80);

29 
c§_y
 = 25 - 1;

31 
	}
}

35 
	$move_c§
()

37 
ãmp
;

42 
ãmp
 = 
c§_y
 * 80 + 
c§_x
;

51 
	`ouç‹tb
(0x3D4, 14);

52 
	`ouç‹tb
(0x3D5, 
ãmp
 >> 8);

53 
	`ouç‹tb
(0x3D4, 15);

54 
	`ouç‹tb
(0x3D5, 
ãmp
);

55 
	}
}

58 
	$˛s
()

60 
bœnk
;

61 
i
;

65 
bœnk
 = 0x20 | (
©åib
 << 8);

69 
i
 = 0; i < 25; i++)

70 
	`mem£tw
 (
ãxtmem±r
 + 
i
 * 80, 
bœnk
, 80);

74 
c§_x
 = 0;

75 
c§_y
 = 0;

76 
	`move_c§
();

77 
	}
}

80 
	$putch
(
c
)

82 *
whîe
;

83 
©t
 = 
©åib
 << 8;

86 if(
c
 == 0x08)

88 if(
c§_x
 != 0) csr_x--;

92 if(
c
 == 0x09)

94 
c§_x
 = (csr_x + 8) & ~(8 - 1);

98 if(
c
 == '\r')

100 
c§_x
 = 0;

105 if(
c
 == '\n')

107 
c§_x
 = 0;

108 
c§_y
++;

114 if(
c
 >= ' ')

116 
whîe
 = 
ãxtmem±r
 + (
c§_y
 * 80 + 
c§_x
);

117 *
whîe
 = 
c
 | 
©t
;

118 
c§_x
++;

123 if(
c§_x
 >= 80)

125 
c§_x
 = 0;

126 
c§_y
++;

130 
	`s¸ﬁl
();

131 
	`move_c§
();

132 
	}
}

135 
	$puts
(*
ãxt
)

137 
i
;

139 
i
 = 0; i < 
	`°æí
(
ãxt
); i++)

141 
	`putch
(
ãxt
[
i
]);

143 
	}
}

146 
	$£âextcﬁ‹
(
f‹ecﬁ‹
, 
backcﬁ‹
)

150 
©åib
 = (
backcﬁ‹
 << 4Ë| (
f‹ecﬁ‹
 & 0x0F)

151 
	}
}

154 
	$öô_video
()

156 
ãxtmem±r
 = (*)0xB8000;

157 
	`˛s
();

158 
	}
}

	@time.c

1 
	~< sy°em.h 
>

5 
	gtimî_ticks
 = 0;

12 
	$timî_h™dÀr
(
ªgs
 *
r
)

15 
timî_ticks
++;

19 i‡(
timî_ticks
 % 18 == 0)

21 
	`puts
("One second hasÖassed\n");

23 
	}
}

27 
	$timî_ö°Æl
()

30 
	`úq_ö°Æl_h™dÀr
(0, 
timî_h™dÀr
);

31 
	}
}

33 
	$timî_pha£
(
hz
)

35 
divis‹
 = 1193180 / 
hz
;

36 
	`ouç‹tb
(0x43, 0x36);

37 
	`ouç‹tb
(0x40, 
divis‹
 & 0xFF);

38 
	`ouç‹tb
(0x40, 
divis‹
 >> 8);

39 
	}
}

42 
	$timî_waô
(
ticks
)

44 
ëicks
;

46 
ëicks
 = 
timî_ticks
 + 
ticks
;

47 
timî_ticks
 < 
ëicks
);

48 
	}
}

	@
1
.
1
/usr/include
8
51
gdt.c
idt.c
irq.c
isrs.c
kb.c
main.c
scrn.c
time.c
